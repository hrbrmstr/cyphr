<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Rich FitzJohn" />

<meta name="date" content="2017-05-08" />

<title>Data Encryption</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">Data Encryption</h1>
<h4 class="author"><em>Rich FitzJohn</em></h4>
<h4 class="date"><em>2017-05-08</em></h4>
</div>


<p><strong>The scenario:</strong></p>
<p>A group of people are working on a sensitive data set that for practical reasons needs to be stored in a place that we’re not 100% happy with the securtity (e.g., dropbox), or we’re concerned that files stored in plain text on users computers (e.g. laptops) may lead to the data being compromised.</p>
<p>If the data can be stored encrypted but everyone in the group can still read and write the data then we’ve improved the situation somewhat. But organising for everyone to get a copy of the key to decrypt the data files is nontrivial. The workflow described here aims to simplify this proceedure using lower-level functions in the <code>cyphr</code> package.</p>
<p>The general proceedure is this:</p>
<ol style="list-style-type: decimal">
<li><p>A person will set up a set of personal keys and a key for the data. The data key will be encrypted with their personal key so they have access to the data but nobody else does. At this point the data can be encrypted.</p></li>
<li><p>Additional users set up personal keys and request access to the data. Anyone with access to the data can grant access to anyone else.</p></li>
</ol>
<p>We’ll store data in the directory <code>data</code>; at present there is nothing there.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_dir &lt;-<span class="st"> &quot;data&quot;</span>
<span class="kw">dir.create</span>(data_dir)
<span class="kw">dir</span>(data_dir)</code></pre></div>
<pre><code>## character(0)</code></pre>
<p><strong>First</strong>, create a personal set of keys. These will be shared across all projects and stored away from the data. Ideally one would do this with <code>ssh-keygen</code> at the command line, following one of the many guides available. A utility function <code>ssh_keygen</code> (which simply calls <code>ssh-keygen</code> for you) is available in this package though. You will need to generate a key on each computer you want access from. Don’t copy the key around. If you lose your user key you will lose access to the data!</p>
<p><strong>Second</strong>, create a key for the data and encrypt that key with your personal key. Note that the data key is never stored directly - it is always stored encrypted by a personal key.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_init</span>(data_dir)</code></pre></div>
<pre><code>## Generating data key</code></pre>
<pre><code>## Authorising ourselves</code></pre>
<pre><code>## Adding key b6:57:62:fb:b9:1c:a2:5a:35:b5:37:21:e7:ae:23:52
##   user: rich
##   host: Richs-MBP.default
##   date: 2017-05-08 20:25:35</code></pre>
<pre><code>## Verifying</code></pre>
<p>The data key is very important. If it is deleted, then the data cannot be decrypted. So do not delete the directory <code>data_dir/.cyphr</code>! Ideally add it to your version control system so that it cannot be lost. Of course, if you’re working in a group, there are multiple copies of the data key (each encrypted with a different person’s personal key) which reduces the chance of total loss.</p>
<p>This command can be run multiple times safely; if it detects it has been rerun and the data key will not be regenerated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_init</span>(data_dir)</code></pre></div>
<pre><code>## Already set up</code></pre>
<pre><code>## Verifying</code></pre>
<p><strong>Third</strong>, you can add encrypted data to the directory (or to anywhere really). When run, <code>cyphr::config_data</code> will verify that it can actually decrypt things.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">key &lt;-<span class="st"> </span>cyphr::<span class="kw">data_key</span>(data_dir)</code></pre></div>
<p>This object can be used with all the <code>cyphr</code> functions (see the “cyphr” vignette; <code>vignette(&quot;cyphr&quot;)</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">filename &lt;-<span class="st"> </span><span class="kw">file.path</span>(data_dir, <span class="st">&quot;iris.rds&quot;</span>)
cyphr::<span class="kw">encrypt</span>(<span class="kw">saveRDS</span>(iris, filename), key)
<span class="kw">dir</span>(data_dir)</code></pre></div>
<pre><code>## [1] &quot;iris.rds&quot;</code></pre>
<p>The file is encrypted and so cannot be read with <code>readRDS</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">readRDS</span>(filename)</code></pre></div>
<pre><code>## Error in readRDS(filename): unknown input format</code></pre>
<p>But we can decrypt and read it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cyphr::<span class="kw">decrypt</span>(<span class="kw">readRDS</span>(filename), key))</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<p><strong>Fourth</strong>, have someone else join in. To simulate another person here, I’m going to pass an argument <code>bob</code> though to the functions. This contains the path to “Bob”’s ssh keypair. If run on an actually different computer this would not be needed; this is just to simulate two users in a single session for this vignette (see minimal example below where this is simulated). Again, typically this user would also not use the <code>cyphr::ssh_keygen</code> function but use the <code>ssh-keygen</code> command from their shell.</p>
<p>We’re going to assume that the user can read and write to the data. This is the case for my use case where the data are stored on dropbox and will be the case with github based distribution, though there would be a pull request step in here.</p>
<p>This user cannot read the data, though trying to will print a message explinaing how you might request access:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">key_bob &lt;-<span class="st"> </span>cyphr::<span class="kw">data_key</span>(data_dir, <span class="st">&quot;bob&quot;</span>)</code></pre></div>
<pre><code>## Error: Key file not found; you may not have access
## (looked in data/.cyphr/84e1e3743bbee9af67b38f591da9299e)
## To request access, run:
##   data_request_access(&quot;data&quot;)</code></pre>
<p>But <code>bob</code> is your collaborator and needs access! What they need to do is run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_request_access</span>(data_dir, <span class="st">&quot;bob&quot;</span>)</code></pre></div>
<pre><code>## A request has been added</code></pre>
<pre><code>## Email someone with access to add you.</code></pre>
<pre><code>##  hash: 84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e</code></pre>
<pre><code>## If you are using git, you will need to commit and push first:
##     git add data/.cyphr/requests/84e1e3743bbee9af67b38f591da9299e
##     git commit -m &quot;Please add me to the dataset&quot;
##     git push</code></pre>
<p>(again, ordinarily you would not need the <code>bob</code> bit here)</p>
<p>The user should the send an email to someone with access and quote the hash in the message above.</p>
<p><strong>Fifth</strong>, back on the first computer we can authorise the second user. First, see who has requested access:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">req &lt;-<span class="st"> </span>cyphr::<span class="kw">data_admin_list_requests</span>(data_dir)
req</code></pre></div>
<pre><code>## 1 key:
##   84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e
##     user: rich
##     host: Richs-MBP.default
##     date: 2017-05-08 20:25:35</code></pre>
<p>We can see the same hash here as above (<code>84e1e3743bbee9af67b38f591da9299e</code>)</p>
<p>…and then grant access to them with the <code>cyphr::data_admin_authorise</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_authorise</span>(data_dir, <span class="dt">yes =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## There is 1 request for access</code></pre>
<pre><code>## Adding key 84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e
##   user: rich
##   host: Richs-MBP.default
##   date: 2017-05-08 20:25:35</code></pre>
<pre><code>## Added 1 key</code></pre>
<pre><code>## If you are using git, you will need to commit and push:
##     git add .cyphr
##     git commit -m &quot;Authorised rich&quot;
##     git push</code></pre>
<p>If you do not specify <code>yes = TRUE</code> will prompt for confirmation at each key added.</p>
<p>This has cleared the request queue:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_list_requests</span>(data_dir)</code></pre></div>
<pre><code>## (empty)</code></pre>
<p>and added it to our set of keys:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_list_keys</span>(data_dir)</code></pre></div>
<pre><code>## 2 keys:
##   84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e
##     user: rich
##     host: Richs-MBP.default
##     date: 2017-05-08 20:25:35
##   b6:57:62:fb:b9:1c:a2:5a:35:b5:37:21:e7:ae:23:52
##     user: rich
##     host: Richs-MBP.default
##     date: 2017-05-08 20:25:35</code></pre>
<p><strong>Finally</strong>, as soon as the authorisation has happened, the user can encrypt and decrypt files:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">key_bob &lt;-<span class="st"> </span>cyphr::<span class="kw">data_key</span>(data_dir, <span class="st">&quot;bob&quot;</span>)
<span class="kw">head</span>(cyphr::<span class="kw">decrypt</span>(<span class="kw">readRDS</span>(filename), key_bob))</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div id="minimal-example" class="section level2">
<h2>Minimal example</h2>
<p>As above, but with less discussion:</p>
<p>Setup, on computer 1:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_init</span>(data_dir)</code></pre></div>
<pre><code>## Generating data key</code></pre>
<pre><code>## Authorising ourselves</code></pre>
<pre><code>## Adding key b6:57:62:fb:b9:1c:a2:5a:35:b5:37:21:e7:ae:23:52
##   user: rich
##   host: Richs-MBP.default
##   date: 2017-05-08 20:25:35</code></pre>
<pre><code>## Verifying</code></pre>
<p>Encrypt a file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">encrypt</span>(<span class="kw">saveRDS</span>(iris, filename), cyphr::<span class="kw">data_key</span>(data_dir))</code></pre></div>
<p>Request access, on computer 2:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hash &lt;-<span class="st"> </span>cyphr::<span class="kw">data_request_access</span>(data_dir)</code></pre></div>
<pre><code>## A request has been added</code></pre>
<pre><code>## Email someone with access to add you.</code></pre>
<pre><code>##  hash: 84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e</code></pre>
<pre><code>## If you are using git, you will need to commit and push first:
##     git add data/.cyphr/requests/84e1e3743bbee9af67b38f591da9299e
##     git commit -m &quot;Please add me to the dataset&quot;
##     git push</code></pre>
<p>Authorise, on computer 1:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cyphr::<span class="kw">data_admin_authorise</span>(data_dir, <span class="dt">yes =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## There is 1 request for access</code></pre>
<pre><code>## Adding key 84:e1:e3:74:3b:be:e9:af:67:b3:8f:59:1d:a9:29:9e
##   user: rich
##   host: Richs-MBP.default
##   date: 2017-05-08 20:25:35</code></pre>
<pre><code>## Added 1 key</code></pre>
<pre><code>## If you are using git, you will need to commit and push:
##     git add .cyphr
##     git commit -m &quot;Authorised rich&quot;
##     git push</code></pre>
<p>Read data, on computer 2:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cyphr::<span class="kw">decrypt</span>(<span class="kw">readRDS</span>(filename), cyphr::<span class="kw">data_key</span>(data_dir)))</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
</div>
<div id="details-disclosure" class="section level2">
<h2>Details &amp; disclosure</h2>
<p>Encryption does not work through security through obscurity; it works because we can rely on the underlying maths enough to be open about how things are stored and where.</p>
<p>Most encryption libraries work require some degree of security in the underlying software. Because of the way R works this is very difficult to guarantee; it is trivial to rewrite code in running packages to skip past verification checks. So this package is <em>not</em> designed to (or able to) avoid exploits in your running code; an attacker could intercept your private keys, the private key to the data, or skip the verification checks that are used to make sure that the keys you load are what they say they are. However, the <em>data</em> are safe; only people who have keys to the data will be able to read it.</p>
<p>Cyphr uses two different encryption algorithms; it uses rsa encryption via the <code>openssl</code> package for user keys, because there is a common file format for these keys so it makes user configuration easier. It uses the modern sodium package (and through that the libsodium library) for data encryption because it is very fast and simple to work with. This does leave two possible points of weakness as a vulnerability in either of these libraries could lead to an exploit that could allow decryption of your data.</p>
<p>Each user has a public/private key pair. Typically this is in <code>~/.ssh/id_rsa.pub</code> and <code>~/.ssh/id_rsa</code>, and if found these will be used. Alternatively the location of the keypair can be stored elsewhere and pointed at with the <code>USER_KEY</code> or <code>USER_PUBKEY</code> environment variables. The key may be password protected (and this is recommended!) and the password will be requested without ever echoing it to the terminal.</p>
<p>The data directory has a hidden directory <code>.cyphr</code> in it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir</span>(<span class="st">&quot;data&quot;</span>, <span class="dt">all.files =</span> <span class="ot">TRUE</span>, <span class="dt">no.. =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] &quot;.cyphr&quot;   &quot;iris.rds&quot;</code></pre>
<p>This does not actually need to be stored with the data but it makes sense to (there are workflows where data is stored remotely where storing this directory might make sense). This directory contains a number of files; one for each person who has access to the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir</span>(<span class="kw">file.path</span>(<span class="st">&quot;data/.cyphr&quot;</span>))</code></pre></div>
<pre><code>## [1] &quot;84e1e3743bbee9af67b38f591da9299e&quot; &quot;b65762fbb91ca25a35b53721e7ae2352&quot;
## [3] &quot;test&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(cyphr::<span class="kw">data_admin_list_keys</span>(<span class="st">&quot;data&quot;</span>))</code></pre></div>
<pre><code>## [1] &quot;84e1e3743bbee9af67b38f591da9299e&quot; &quot;b65762fbb91ca25a35b53721e7ae2352&quot;</code></pre>
<p>(the file <code>test</code> is a small file encrypted with the data key used to verify everything is working OK).</p>
<p>Each file is stored in RDS format and is a list with elements:</p>
<ul>
<li>user: the reported user name of the person who created request for data</li>
<li>host: the reported computer name</li>
<li>date: the time the request was generated</li>
<li>pub: the rsa public key of the user</li>
<li>signature: the signature of the contents of “user”, “host”, “date”, “pub”. This ensures that the data have not been changed since they were created.</li>
<li>key: the data key, encrypted with the user key. Without the private key, this cannot be used. With the user’s private key this can be used to generate the symmetric key to the data.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">h &lt;-<span class="st"> </span><span class="kw">names</span>(cyphr::<span class="kw">data_admin_list_keys</span>(<span class="st">&quot;data&quot;</span>))[[<span class="dv">1</span>]]
<span class="kw">readRDS</span>(<span class="kw">file.path</span>(<span class="st">&quot;data/.cyphr&quot;</span>, h))</code></pre></div>
<pre><code>## $user
## [1] &quot;rich&quot;
## 
## $host
## [1] &quot;Richs-MBP.default&quot;
## 
## $date
## [1] &quot;2017-05-08 20:25:35 BST&quot;
## 
## $pub
## [2048-bit rsa public key]
## md5: 84e1e3743bbee9af67b38f591da9299e
## 
## $signature
##   [1] 83 bc 52 8e de 1a af d9 1a cb ea 7b c6 59 10 d8 4c d1 dc 73 7a 84 4a
##  [24] 83 47 e4 73 7b 9b e6 16 6a c1 8e 5a b5 c7 d2 28 58 a1 da f8 0c 88 a6
##  [47] 8d 41 d4 30 2d 9b 1d 36 f2 55 a1 ce 85 1a ee d4 b2 2c 93 89 2c 37 bc
##  [70] 37 a3 a9 28 cb 0b b4 df 69 67 9c b9 29 9e 2a 69 e3 5b f2 c8 de 52 1c
##  [93] a8 51 44 c8 8f 00 a4 52 8e 69 7e 45 10 77 11 5e fc 34 fe 98 f3 93 a2
## [116] de 10 ad 3e cf 3e 34 a7 83 ac ad 9c 8e 47 2f f5 79 a2 93 8d 24 78 65
## [139] 56 a6 81 ae 59 e4 70 c6 a3 62 df c2 3b b2 80 fb b3 9b 3a 0c 3f 9d ca
## [162] f8 12 73 bb c5 4f 84 6e da 6f 3c a6 14 89 cd 93 73 13 77 b6 25 a4 f4
## [185] 92 80 6b 19 3d 9f 7a 3f ae 18 58 40 7d 60 fd 87 f3 3e 5c 5b ff 4d 37
## [208] e4 1d 82 45 50 c1 ac 7c 69 c3 44 1f 23 ad 72 36 86 59 cb b0 57 c2 ed
## [231] 05 96 29 cf 4e 31 64 d6 d4 84 f0 6d 7d 46 42 cc fc eb 64 94 48 fd 01
## [254] 9c 7e c4
## 
## $key
##   [1] 4c 05 90 61 b2 05 a0 b0 ca 56 94 95 a6 ef 7e 30 f0 1d 59 01 58 f3 d7
##  [24] ec 96 71 4f d4 82 58 ac 36 51 e2 fe b1 c0 f6 00 6f 13 29 3b 0a 59 fa
##  [47] c3 53 3d 88 6b 6e c8 60 61 4d cb a2 8b 8f 9f 4c 4a a2 68 9d c8 35 f9
##  [70] 66 c2 bd 03 a3 79 80 4d 85 84 c5 cd 03 fb 7f 45 e2 a9 95 87 3d 87 32
##  [93] 92 71 25 4e 81 9c bc b3 2a 73 3d 59 14 24 c7 7e a8 97 a4 08 28 fd 48
## [116] d7 63 75 66 96 16 28 43 c6 6c 9f 84 b2 2a ca 26 7f 27 92 ff 9e 42 af
## [139] a3 db 8d 59 f7 e5 ff 1b cc 5d 66 9d f3 c8 71 c5 f2 4d 44 e5 16 c7 ac
## [162] 4d a6 e5 e2 21 7b c7 e3 79 80 e6 8a 9e 1e a1 d8 fc 38 19 98 e0 a3 01
## [185] b2 83 41 59 a1 6b 84 0f 94 4e c4 f8 fb a1 4b cf 6e c1 ec ba 05 6f 15
## [208] f4 5a cb 77 d3 32 5d 97 a9 ba 89 6a e2 35 2f 65 39 c1 f0 9b c2 fb 8c
## [231] 2d de fc dc 8b 11 06 ab 66 9f 8c df c9 4e 08 e8 77 b8 f6 7d 72 ef b3
## [254] 96 c5 6a</code></pre>
<p>You can see that the hash of the public key is the same as name of the stored file here (which is used to prevent collisions when multiple people request access at the same time).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">h</code></pre></div>
<pre><code>## [1] &quot;84e1e3743bbee9af67b38f591da9299e&quot;</code></pre>
<p>When a request is posted it is an RDS file with all of the above except for the <code>key</code> element, which is added during authorisation.</p>
<p>(Note that the verification relies on the package code not being attacked, and given R’s highly dynamic nature an attacker could easily swap out the definition for the verification function with something that always returns <code>TRUE</code>.)</p>
<p>When an authorised user creates the <code>data_key</code> object (which allows decryption of the data) <code>secret</code> will:</p>
<ul>
<li>read their private user key (probably from <code>~/.ssh/id_rsa</code>)</li>
<li>read the encrypted data key from the data directory (the <code>$key</code> element from the list above).</li>
<li>decrypt this data key using their user key to yield the the data symmetric key.</li>
</ul>
</div>
<div id="limitations" class="section level2">
<h2>Limitations</h2>
<p>In the dropbox scenario, non-password protected keys will afford only limited protection. This is because even though the keys and data are stored separately on dropbox, they will be in the same place on a local computer; if that computer is lost then the only thing preventing an attacker recovering the data is security through obscuritty (the data would appear to be random junk but they will be able to run your analysis scripts as easily as you can). Password protected keys will improve this situation considerably as without a password the data cannot be recovered.</p>
<p>The data is not encrypted during a running R session. R allows arbitrary modification of code at runtime so this package provides no security from the point where the data can be decrypted. If your computer was compromised then stealing the data while you are running R should be assumed to be straightforward.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
